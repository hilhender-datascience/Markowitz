---
title: "P4: Teoria Moderna de Portfólio de Markowitz e VaR"
author: "Raphael Marques Franco"
date: "`r Sys.Date()`"
output: 
 html_document:
    toc: true
    toc_float: true
    toc_depth: 3
    number_sections: true
    theme: cosmo
    highlight: tango
    code_folding: hide
    fig_caption: true
    df_print: paged
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE, 
                      fig.align = 'center')

# Configurar para não usar notação científica
options(scipen = 999)
```

# 1. Carregamento de Pacotes

```{r pacotes}
# Pacotes para análise estatística
library(moments)     # Testes de assimetria e curtose
library(nortest)     # Testes de normalidade

# Pacotes para visualização e manipulação
library(ggplot2)     # Gráficos
library(tidyr)       # Manipulação de dados
library(dplyr)       # Manipulação de dados
library(knitr)       # Tabelas formatadas
library(zoo)         # Séries temporais
library(quadprog)    # Otimização quadrática
library(xts)         # Séries temporais estendidas
library(kableExtra)  # Formatar tabelas
```

# 2. Definição de Parâmetros

```{r parametros}
# Ações a serem analisadas
nomes_acoes <- c("POMO3", "AURE3", "BBAS3", "ITUB3")

# Parâmetros para VaR
investimento <- 100000  # R$ 100.000,00
confianca <- 0.99       # 99% de confiança
janela <- 252           # 252 dias úteis (1 ano)
```

# 3. Leitura dos Dados do CSV

```{r leitura_dados}
# Ler o arquivo CSV
# Importante: ajustar o separador conforme o formato do arquivo
dados_csv <- read.csv("data.csv", 
                      sep = ";",           # Separador de colunas
                      dec = ",",           # Separador decimal
                      stringsAsFactors = FALSE)

# Remover a primeira coluna vazia se existir
if(names(dados_csv)[1] == "" || names(dados_csv)[1] == "X") {
  dados_csv <- dados_csv[, -1]
}

# Converter coluna de Data para formato Date
dados_csv$Data <- as.Date(dados_csv$Data, format = "%d/%m/%Y")

# Converter colunas numéricas (remover vírgulas e converter para numeric)
colunas_numericas <- c("POMO3", "AURE3", "BBAS3", "ITUB3", "IBOV", "SELIC")

for(col in colunas_numericas) {
  if(col %in% names(dados_csv)) {
    # Substituir vírgula por ponto e converter para numérico
    dados_csv[[col]] <- as.numeric(gsub(",", ".", dados_csv[[col]]))
  }
}

# Ordenar por data
dados_csv <- dados_csv[order(dados_csv$Data), ]

# Exibir informações sobre os dados carregados
cat("### Dados Carregados do CSV:\n\n")
cat("Total de observações:", nrow(dados_csv), "\n")
cat("Período:", min(dados_csv$Data), "a", max(dados_csv$Data), "\n")
cat("Variáveis:", paste(names(dados_csv), collapse = ", "), "\n\n")

# Exibir primeiras linhas
kable(head(dados_csv, 10), digits = 4,
      caption = "Primeiras 10 linhas dos dados")
```

# 4. Preparação dos Dados para Análise

```{r preparacao_dados}
# Criar objetos xts para as séries temporais
# Preços das ações
precos <- xts(dados_csv[, nomes_acoes], order.by = dados_csv$Data)
colnames(precos) <- nomes_acoes

# IBOVESPA
ibovespa <- xts(dados_csv$IBOV, order.by = dados_csv$Data)
colnames(ibovespa) <- "IBOVESPA"

# SELIC (já em % a.a. no CSV)
# Converter para taxa diária equivalente
selic_anual <- dados_csv$SELIC
selic_diaria <- (1 + selic_anual/100)^(1/252) - 1

# Criar dataframe com informações da SELIC
selic_data <- data.frame(
  ref.date = dados_csv$Data,
  value = selic_anual,
  taxa_diaria = selic_diaria
)

cat("\n### Resumo dos Dados Preparados:\n\n")
cat("Taxa SELIC média (% a.a.):", round(mean(selic_anual, na.rm = TRUE), 2), "\n")
cat("Taxa SELIC atual (% a.a.):", tail(selic_anual, 1), "\n")
cat("Taxa diária equivalente:", 
    round(tail(selic_diaria, 1) * 100, 4), "%\n\n")

# Resumo dos preços
resumo_precos <- data.frame(
  Acao = nomes_acoes,
  Preco_Inicial = as.numeric(precos[1, ]),
  Preco_Final = as.numeric(precos[nrow(precos), ]),
  Retorno_Periodo = ((as.numeric(precos[nrow(precos), ]) / 
                       as.numeric(precos[1, ])) - 1) * 100
)

kable(resumo_precos, digits = 2,
      caption = "Resumo dos Preços das Ações")
```

# 5. Visualização dos Dados Coletados

## 5.1 Gráficos de Preços de Fechamento

```{r grafico_precos, fig.height=6.5, fig.width=7.5}
# Converter para dataframe para ggplot2
precos_df <- data.frame(Data = index(precos), coredata(precos))

# Transformar para formato longo
precos_long <- precos_df %>%
  pivot_longer(cols = -Data, names_to = "Acao", values_to = "Preco")

# Gráfico de preços
ggplot(precos_long, aes(x = Data, y = Preco, color = Acao)) +
  geom_line(linewidth = 1) +
  facet_wrap(~Acao, scales = "free_y", ncol = 2) +
  labs(title = "Evolução dos Preços de Fechamento",
       subtitle = paste0("Período: ", min(dados_csv$Data), " a ", 
                        max(dados_csv$Data)),
       x = "Data",
       y = "Preço de Fechamento (R$)") +
  theme_minimal() +
  theme(legend.position = "none",
        plot.title = element_text(hjust = 0.5, size = 14, face = "bold"),
        plot.subtitle = element_text(hjust = 0.5, size = 10))
```

## 5.2 Gráfico do IBOVESPA

```{r grafico_ibovespa, fig.height=5, fig.width=7.5}
ibov_df <- data.frame(Data = index(ibovespa), IBOVESPA = coredata(ibovespa))

ggplot(ibov_df, aes(x = Data, y = IBOVESPA)) +
  geom_line(color = "darkblue", linewidth = 1) +
  labs(title = "Evolução do IBOVESPA",
       x = "Data",
       y = "Pontos") +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5, size = 14, face = "bold"))
```

## 5.3 Evolução da Taxa SELIC

```{r grafico_selic, fig.height=5, fig.width=7.5}
selic_df <- data.frame(Data = dados_csv$Data, SELIC = selic_anual)

ggplot(selic_df, aes(x = Data, y = SELIC)) +
  geom_line(color = "darkred", linewidth = 1) +
  geom_point(color = "darkred", size = 1) +
  labs(title = "Evolução da Taxa SELIC",
       x = "Data",
       y = "Taxa SELIC (% a.a.)") +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5, size = 14, face = "bold"))
```

# 6. Cálculo dos Retornos Logarítmicos

```{r retornos}
# Retornos logarítmicos das ações
retornos <- na.omit(diff(log(precos)))

# Retorno do IBOVESPA
retorno_ibov <- na.omit(diff(log(ibovespa)))
colnames(retorno_ibov) <- "IBOVESPA"

# Estatísticas descritivas dos retornos
estatisticas <- data.frame(
  Acao = nomes_acoes,
  Media = apply(retornos, 2, mean),
  Desvio_Padrao = apply(retornos, 2, sd),
  Minimo = apply(retornos, 2, min),
  Maximo = apply(retornos, 2, max),
  Assimetria = apply(retornos, 2, skewness),
  Curtose = apply(retornos, 2, kurtosis)
)

kable(estatisticas, digits = 4, 
      caption = "Estatísticas Descritivas dos Retornos Diários")
```

## 6.1 Dataframe Completo: Dados Diários Consolidados

```{r dataframe_consolidado}
# Criar dataframe completo
dados_completos <- data.frame(Data = index(retornos))

# Adicionar preços e retornos de cada ação
for(i in 1:length(nomes_acoes)){
  col_preco <- paste0("Preco_", nomes_acoes[i])
  dados_completos[[col_preco]] <- as.numeric(precos[index(retornos), i])
  
  col_retorno <- paste0("Retorno_", nomes_acoes[i])
  dados_completos[[col_retorno]] <- as.numeric(retornos[, i])
}

# Adicionar IBOVESPA
dados_completos$Preco_IBOVESPA <- as.numeric(ibovespa[index(retornos)])
dados_completos$Retorno_IBOVESPA <- as.numeric(retorno_ibov)

# Adicionar SELIC
selic_subset <- selic_data[selic_data$ref.date %in% dados_completos$Data, ]
dados_completos <- merge(dados_completos, 
                         selic_subset[, c("ref.date", "taxa_diaria")],
                         by.x = "Data", by.y = "ref.date", all.x = TRUE)
colnames(dados_completos)[ncol(dados_completos)] <- "SELIC_Diaria"

# Preencher NAs com última observação
dados_completos$SELIC_Diaria <- zoo::na.locf(dados_completos$SELIC_Diaria, 
                                              na.rm = FALSE)

# Exibir primeiras e últimas linhas
kable(head(dados_completos, 10), digits = 6,
      caption = "Primeiras 10 linhas do DataFrame Consolidado") %>%
  kable_styling(latex_options = c("scale_down", "striped"))

kable(tail(dados_completos, 10), digits = 6,
      caption = "Últimas 10 linhas do DataFrame Consolidado") %>%
  kable_styling(latex_options = c("scale_down", "striped"))
```

## 6.2 Visualização dos Retornos Diários

```{r grafico_retornos, fig.height=7, fig.width=7.5}
retornos_df <- data.frame(Data = index(retornos), coredata(retornos))
retornos_long <- retornos_df %>%
  pivot_longer(cols = -Data, names_to = "Acao", values_to = "Retorno")

ggplot(retornos_long, aes(x = Data, y = Retorno, color = Acao)) +
  geom_line(alpha = 0.6) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "black") +
  facet_wrap(~Acao, ncol = 2) +
  labs(title = "Retornos Logarítmicos Diários",
       subtitle = "Retorno = ln(Pt / Pt-1)",
       x = "Data",
       y = "Retorno") +
  theme_minimal() +
  theme(legend.position = "none",
        plot.title = element_text(hjust = 0.5, size = 14, face = "bold"),
        plot.subtitle = element_text(hjust = 0.5, size = 10))
```

## 6.3 Comparação: Retornos vs IBOVESPA

```{r retornos_vs_ibov, fig.height=7.5, fig.width=7.5}
retornos_completo <- merge(retornos, retorno_ibov)
retornos_comp_df <- data.frame(Data = index(retornos_completo), 
                               coredata(retornos_completo))

par(mfrow = c(2, 2))
for(i in 1:length(nomes_acoes)){
  plot(retornos_comp_df$IBOVESPA, retornos_comp_df[, nomes_acoes[i]],
       main = paste(nomes_acoes[i], "vs IBOVESPA"),
       xlab = "Retorno IBOVESPA",
       ylab = paste("Retorno", nomes_acoes[i]),
       pch = 16, col = rgb(0, 0, 1, 0.3))
  
  abline(lm(retornos_comp_df[, nomes_acoes[i]] ~ retornos_comp_df$IBOVESPA),
         col = "red", lwd = 2)
  
  cor_val <- cor(retornos_comp_df[, nomes_acoes[i]], 
                 retornos_comp_df$IBOVESPA)
  legend("topleft", legend = paste("Corr =", round(cor_val, 3)),
         bty = "n", cex = 1.2)
}
```

# 7. Testes de Normalidade

```{r testes_normalidade}
testar_normalidade <- function(dados, nome){
  cat("\n### Testes de Normalidade para", nome, "\n\n")
  
  sw <- shapiro.test(as.numeric(dados))
  cat("**Shapiro-Wilk:**\n")
  cat("  Estatística W =", round(sw$statistic, 4), "\n")
  cat("  p-valor =", format.pval(sw$p.value, digits = 4), "\n")
  cat("  Conclusão:", ifelse(sw$p.value > 0.05, 
                             "Não rejeita normalidade", 
                             "Rejeita normalidade"), "\n\n")
  
  ad <- ad.test(as.numeric(dados))
  cat("**Anderson-Darling:**\n")
  cat("  Estatística A =", round(ad$statistic, 4), "\n")
  cat("  p-valor =", format.pval(ad$p.value, digits = 4), "\n")
  cat("  Conclusão:", ifelse(ad$p.value > 0.05, 
                             "Não rejeita normalidade", 
                             "Rejeita normalidade"), "\n\n")
  
  jb <- jarque.test(as.numeric(dados))
  cat("**Jarque-Bera:**\n")
  cat("  Estatística JB =", round(jb$statistic, 4), "\n")
  cat("  p-valor =", format.pval(jb$p.value, digits = 4), "\n")
  cat("  Conclusão:", ifelse(jb$p.value > 0.05, 
                             "Não rejeita normalidade", 
                             "Rejeita normalidade"), "\n\n")
  
  return(c(SW = sw$p.value, AD = ad$p.value, JB = jb$p.value))
}

resultados_testes <- data.frame()
for(i in 1:ncol(retornos)){
  p_valores <- testar_normalidade(retornos[,i], nomes_acoes[i])
  resultados_testes <- rbind(resultados_testes, p_valores)
}

rownames(resultados_testes) <- nomes_acoes
kable(resultados_testes, digits = 4, 
      caption = "P-valores dos Testes de Normalidade")
```

## 7.1 Visualização da Distribuição

```{r graficos_distribuicao, fig.height=7.5, fig.width=7.5}
par(mfrow = c(2, 2))

for(i in 1:ncol(retornos)){
  qqnorm(retornos[,i], main = paste("Q-Q Plot -", nomes_acoes[i]))
  qqline(retornos[,i], col = "red", lwd = 2)
  
  hist(retornos[,i], breaks = 30, probability = TRUE,
       main = paste("Histograma -", nomes_acoes[i]),
       xlab = "Retorno", ylab = "Densidade", col = "lightblue")
  
  curve(dnorm(x, mean = mean(retornos[,i]), sd = sd(retornos[,i])),
        add = TRUE, col = "red", lwd = 2)
}
```

# 8. Fronteira Eficiente (Markowitz)

```{r fronteira_eficiente, fig.height=5, fig.width=7.5}
cov_matrix <- cov(retornos)
retornos_medios <- colMeans(retornos)

calc_portfolio <- function(retornos_alvo, retornos_medios, cov_matrix){
  n <- length(retornos_medios)
  Dmat <- 2 * cov_matrix
  dvec <- rep(0, n)
  Amat <- cbind(rep(1, n), retornos_medios, diag(n))
  bvec <- c(1, retornos_alvo, rep(0, n))
  
  resultado <- tryCatch({
    solve.QP(Dmat, dvec, Amat, bvec, meq = 2)
  }, error = function(e){
    return(NULL)
  })
  
  if(is.null(resultado)) return(NULL)
  
  pesos <- resultado$solution
  retorno <- sum(pesos * retornos_medios)
  risco <- sqrt(t(pesos) %*% cov_matrix %*% pesos)
  
  return(list(pesos = pesos, retorno = retorno, risco = as.numeric(risco)))
}

retorno_min <- min(retornos_medios)
retorno_max <- max(retornos_medios)
retornos_alvo <- seq(retorno_min, retorno_max, length.out = 100)

fronteira <- data.frame()

for(ret_alvo in retornos_alvo){
  portfolio <- calc_portfolio(ret_alvo, retornos_medios, cov_matrix)
  
  if(!is.null(portfolio)){
    fronteira <- rbind(fronteira, data.frame(
      Retorno = portfolio$retorno * 252,
      Risco = portfolio$risco * sqrt(252)
    ))
  }
}

acoes_individuais <- data.frame(
  Acao = nomes_acoes,
  Retorno = retornos_medios * 252,
  Risco = apply(retornos, 2, sd) * sqrt(252)
)

ggplot() +
  geom_line(data = fronteira, aes(x = Risco, y = Retorno),
            color = "darkblue", linewidth = 1.5) +
  geom_point(data = acoes_individuais, aes(x = Risco, y = Retorno, color = Acao),
             size = 4) +
  geom_text(data = acoes_individuais, aes(x = Risco, y = Retorno, label = Acao),
            vjust = -1, size = 4) +
  scale_x_continuous(labels = scales::percent_format(accuracy = 0.01)) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 0.01)) +
  labs(title = "Fronteira Eficiente de Markowitz",
       subtitle = "Retornos e Riscos Anualizados",
       x = "Risco (Desvio Padrão Anualizado)",
       y = "Retorno Esperado Anualizado") +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5, size = 14, face = "bold"),
        plot.subtitle = element_text(hjust = 0.5, size = 10),
        legend.position = "right")

kable(acoes_individuais, digits = 4,
      caption = "Retorno e Risco Anualizados das Ações")
```

_O restante do código continua da mesma forma, usando os dados já carregados do CSV..._

# 9. Cálculo do VaR Histórico

```{r var_historico}
calcular_var <- function(retornos_acao, investimento, confianca){
  percentil <- 1 - confianca
  var_percentual <- quantile(retornos_acao, percentil)
  perda_maxima <- -var_percentual * investimento
  
  return(list(
    VaR_percentual = var_percentual,
    Perda_Maxima_Reais = perda_maxima,
    Percentil = percentil * 100
  ))
}

resultados_var <- data.frame()

for(i in 1:ncol(retornos)){
  var_resultado <- calcular_var(retornos[,i], investimento, confianca)
  
  resultados_var <- rbind(resultados_var, data.frame(
    Acao = nomes_acoes[i],
    VaR_Percentual = var_resultado$VaR_percentual,
    Perda_Maxima_R = var_resultado$Perda_Maxima_Reais,
    Investimento_R = investimento,
    Perda_Percentual = (var_resultado$Perda_Maxima_Reais / investimento) * 100
  ))
}

kable(resultados_var, digits = 2,
      caption = paste0("VaR Histórico (", confianca*100, "% de confiança)"))
```

# 10. Conclusões

```{r conclusoes}
cat("\n## CONCLUSÕES PRINCIPAIS\n\n")

acao_maior_risco <- resultados_var$Acao[which.max(resultados_var$Perda_Maxima_R)]
maior_perda <- max(resultados_var$Perda_Maxima_R)

acao_menor_risco <- resultados_var$Acao[which.min(resultados_var$Perda_Maxima_R)]
menor_perda <- min(resultados_var$Perda_Maxima_R)

cat("1. **Maior Risco:** ", acao_maior_risco, 
    " - Perda máxima de R$", format(round(maior_perda, 2), 
                                    big.mark = ".", decimal.mark = ","), "\n\n")

cat("2. **Menor Risco:** ", acao_menor_risco, 
    " - Perda máxima de R$", format(round(menor_perda, 2), 
                                    big.mark = ".", decimal.mark = ","), "\n\n")

cat("3. **Fonte dos Dados:** Análise baseada em dados históricos do arquivo data.csv\n")
cat("   contendo", nrow(dados_csv), "observações de", 
    min(dados_csv$Data), "a", max(dados_csv$Data), "\n")
```